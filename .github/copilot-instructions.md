# Nextcloud News App - Copilot Coding Agent Instructions

## Project Overview

Nextcloud News is an RSS/Atom feed aggregator app for Nextcloud. It's a PHP backend with a Vue.js 3.5 frontend, built as a Nextcloud app that integrates into the Nextcloud server ecosystem.

**Repository Size**: Medium (~50MB source, excluding node_modules/vendor)
**Languages**: PHP (backend), TypeScript/JavaScript/Vue (frontend)
**Target Runtime**: Nextcloud 31-32, PHP 8.2+, Node.js 24+, npm 11.3+
**Frameworks**: Vue 3.5, Vuex, Vite, Vitest for testing

## Key Architecture

### Directory Structure
- `lib/` - PHP backend code (PSR-4 autoloaded as `OCA\News\`)
  - `AppInfo/` - Application configuration and registration
  - `Controller/` - API and page controllers
  - `Service/` - Business logic layer
  - `Db/` - Database entities and mappers
  - `Command/` - CLI commands (occ news:*)
  - `Vendor/` - Scoped PHP dependencies (auto-generated, don't edit directly)
- `src/` - Vue.js frontend source
  - `components/` - Vue components
  - `store/` - Vuex state management
  - `routes/` - Vue Router configuration
- `tests/` - All tests
  - `Unit/` - PHP unit tests (PHPUnit)
  - `javascript/unit/` - JavaScript unit tests (Vitest)
  - `api/` - API integration tests (BATS)
  - `command/` - CLI integration tests (BATS)
- `appinfo/` - Nextcloud app metadata
  - `info.xml` - App configuration and metadata
  - `routes.php` - API route definitions
- `js/` - Compiled JavaScript output (auto-generated by Vite, don't edit)
- `vendor/` - PHP dependencies (Composer, mostly excluded from scoped builds)
- `build/` - Build artifacts (not committed)

### Configuration Files
- `Makefile` - Primary build orchestration
- `composer.json` - PHP dependencies (requires PHP 8.2+)
- `package.json` - Node dependencies (requires Node 24+, npm 11.3+)
- `phpunit.xml` - PHPUnit configuration
- `phpstan.neon.dist` - PHPStan static analysis
- `vite.config.ts` - Vite bundler configuration
- `tsconfig.json` - TypeScript configuration
- `eslint.config.mjs` - ESLint (extends @nextcloud/eslint-config)
- `stylelint.config.cjs` - Stylelint (extends @nextcloud/stylelint-config)

## Build Instructions

### Prerequisites
**CRITICAL**: The project requires specific versions:
- **PHP**: 8.2+ (8.3 recommended)
- **Node.js**: 24.x (package.json specifies ^24.0.0)
- **npm**: 11.3+ (package.json specifies ^11.3.0)
- **Composer**: 2.x
- **make**, **curl**, **which** utilities

**Version Check**: Current environment has Node 20.x and npm 10.x which causes EBADENGINE warnings but still works. For production builds, upgrade to Node 24+ and npm 11.3+.

### Building from Clean State

**ALWAYS follow this exact sequence**:

1. **Clean build** (if needed):
   ```bash
   make distclean  # Removes vendor/, node_modules/, build/, js/*
   ```

2. **Full build** (installs all dependencies and compiles):
   ```bash
   make build
   ```
   **Time**: ~2-3 minutes on first run
   
   This runs:
   - `make composer` - Installs PHP deps and scopes them (~90 seconds)
   - `make npm` - Runs `npm run build` which does `npm ci` then `vite build` (~60 seconds)

3. **Or build components separately**:
   ```bash
   # PHP only (includes dependency scoping - REQUIRED step)
   make composer  # ~90 seconds
   
   # JavaScript only
   make npm  # or: npm ci && npm run build  # ~60 seconds
   ```

### Important Build Notes

**PHP Dependency Scoping**: This project uses PHP-Scoper to namespace all vendor dependencies under `OCA\News\Vendor\`. This prevents conflicts with other Nextcloud apps. The scoping happens automatically during `make composer` via the `composer scope-dependencies` script. Scoped dependencies are placed in `lib/Vendor/` (committed to repo). Never manually edit `lib/Vendor/` - always regenerate via `composer scope-dependencies`.

**Node Warnings**: You may see `EBADENGINE` warnings about Node 24/npm 11.3 being required. These are warnings, not errors - builds work with Node 20/npm 10 but prefer the specified versions.

**Build Output**: JavaScript builds to `js/` directory (gitignored except in releases). Files include:
- `news-main.mjs` - Main app bundle
- `news-admin-settings.mjs` - Admin settings
- `news-cron-warning.mjs` - Cron warning component
- `*.chunk.mjs` - Code-split chunks
- `*.license` - License info files

## Developer Environment Setup

**IMPORTANT**: To run PHP unit tests and integration tests, you need a full Nextcloud server installation. The News app cannot run PHP tests standalone.

### Setup for GitHub Copilot Agents

**Context**: When working on this repository, GitHub has already cloned the News app for you. However, PHP tests require the News app to be installed within a Nextcloud server structure.

**Required Directory Structure**:
```
/some/parent/directory/
├── server/                    # Nextcloud server
│   ├── apps/
│   │   └── news/             # News app (symlinked or moved here)
│   ├── occ
│   ├── data/
│   └── ...
└── news/                      # Original cloned News repo (this workspace)
```

**Setup Steps** (run these commands from the News app directory):

```bash
# Step 1: Clone Nextcloud server (adjacent to News repo, not inside it)
cd ..  # Go up one level from the News repo
git clone --depth 1 --branch stable32 https://github.com/nextcloud/server.git
cd server
git submodule update --init

# Step 2: Install Nextcloud
php ./occ maintenance:install --database=sqlite --admin-user=admin --admin-pass=admin

# Step 3: Link the News app into the server's apps directory
# (Using symlink to keep working in the original repo)
cd apps
ln -s ../../news news  # Assuming news repo is ../news relative to server/
cd news

# Step 4: Build the News app (now from server/apps/news)
make build

# Step 5: Enable the app
cd ../..  # Back to server root
php ./occ app:enable news

# Step 6: All future work should be done from server/apps/news
cd apps/news
```

**Alternative: Move instead of symlink**:
```bash
# After cloning server (from parent directory containing both repos)
mv news server/apps/
cd server/apps/news
# Continue from step 4 above
```

**CRITICAL**: After setup, **always work from `server/apps/news`** directory, not the original clone location. This ensures PHP tests can find Nextcloud's bootstrap files.

### Running Tests with Nextcloud Server

Once Nextcloud is set up:

**PHP Unit Tests** (from `server/apps/news`):
```bash
make php-test-dependencies  # Install test dependencies
make unit-test  # Run PHPUnit tests
```

**Integration Tests** (requires running servers):
```bash
# Terminal 1: Start feed server (from server/apps/news)
make feed-server  # Runs on localhost:8090

# Terminal 2: Start Nextcloud server (from server root)
cd ../..  # Go to server root
php -S localhost:8080

# Terminal 3: Run tests (from server/apps/news)
bats tests/api      # API integration tests
bats tests/command  # CLI integration tests
```

**JavaScript Tests** (can run from anywhere in News app):
```bash
npm run test  # Runs vitest - doesn't need Nextcloud
npm run lint  # ESLint
npm run stylelint  # Style linting
```

**Debugging**: Check Nextcloud logs at `server/data/nextcloud.log`

For more setup details, see:
- `docs/developer.md` - Complete developer setup guide
- `docs/install.md` - Installation and build dependencies
- `docker/README.md` - Docker environment details
- `.devcontainer/README.md` - DevContainer setup

## Testing

### JavaScript Tests

Run with:
```bash
npm run test  # Runs vitest
npm run test:coverage  # With coverage report
```
**Time**: ~20-30 seconds
**Output**: Test results in console, coverage in `coverage/`
**All tests must pass** - 229 tests across 26 files as of last check

### Linting

**JavaScript/TypeScript**:
```bash
npm run lint  # ESLint check
npm run lint:fix  # Auto-fix issues
```
**Time**: ~5-10 seconds

**CSS/SCSS**:
```bash
npm run stylelint  # Check styles
npm run stylelint:fix  # Auto-fix
```
**Time**: ~5 seconds

**PHP Code Style** (PSR-2):
```bash
make phpcs
```
**Requirements**: Needs `make php-test-dependencies` first (installs dev deps)
**Time**: ~10 seconds
**Note**: News uses PSR-2 style (different from Nextcloud core)

**PHP Static Analysis**:
```bash
make phpstan
```
**Requirements**: Needs `make php-test-dependencies` first
**Time**: ~20-30 seconds

### PHP Unit Tests

**IMPORTANT**: PHP tests require a full Nextcloud server installation. They cannot run standalone.

```bash
make php-test-dependencies  # Install test dependencies (~2 minutes)
make unit-test  # Runs PHPUnit with coverage
```

**Requirements**: 
- Tests expect `../../../tests/bootstrap.php` (Nextcloud server)
- Must be run from within a Nextcloud server `apps/news/` directory
- See GitHub workflow `.github/workflows/api-php-tests.yml` for full setup

### Integration Tests (BATS)

**API Tests**: Require running Nextcloud server on `localhost:8080` and feed server on `localhost:8090`
```bash
make feed-server &  # Start feed server
make nextcloud-server &  # Start Nextcloud server
bats tests/api  # Run API tests
```

**Command Tests**: Require feed server on `localhost:8090`
```bash
make feed-server &
bats tests/command  # Run CLI tests
```

### Complete Test Suite
```bash
make test  # Runs all: php-test-dependencies, unit-test, phpcs, phpstan, js-test
```
**Time**: ~5-7 minutes total
**Note**: Requires Nextcloud server setup

## GitHub Workflows / CI Checks

All PRs must pass these checks:

1. **Node tests** (`.github/workflows/node-test.yml`)
   - Runs `npm ci && npm run build && npm run test && npm run test:coverage`
   - Node version from package.json engines
   - Must pass for merge

2. **ESLint** (`.github/workflows/lint-eslint.yml`)
   - Runs `npm ci && npm run lint`
   - Must pass for merge

3. **Stylelint** (`.github/workflows/lint.yml`)
   - Runs `npm ci && npm run stylelint`
   - Must pass for merge

4. **PHP Tests** (`.github/workflows/api-php-tests.yml`)
   - Sets up Nextcloud server with the app
   - Runs `make` then `make php-test-dependencies` then `make unit-test`
   - Tests with PHP 8.3, Nextcloud stable31, SQLite
   - Must pass for merge

5. **Static Analysis** (`.github/workflows/api-php-static-code-check.yml`)
   - Multiple PHP versions (8.2, 8.3, 8.4) and Nextcloud versions
   - Runs `make composer`, `make php-test-dependencies`, `make phpcs`, `make phpstan`
   - May fail for experimental versions (continue-on-error)

6. **Integration Tests** (`.github/workflows/api-integration-tests.yml`)
   - Multiple databases (SQLite, PostgreSQL, MySQL)
   - Sets up Nextcloud, starts PHP servers, runs BATS tests
   - `bats apps/news/tests/api` and `bats apps/news/tests/command`

7. **Changelog Enforcer** (`.github/workflows/changelog-enforcer.yml`)
   - **CRITICAL**: Every PR must update `CHANGELOG.md` following [Keep a Changelog](https://keepachangelog.com/) format
   - OR add `Skip-Changelog` label to PR
   - Will block merge if not satisfied

8. **Info.xml Lint** (`.github/workflows/lint-info-xml.yml`)
   - Validates `appinfo/info.xml` against schema

9. **Text Lint** (`.github/workflows/lint-text.yml`)
   - Vale linter for documentation

## Common Workflows and Tips

### Making Code Changes

1. **For PHP backend changes**:
   - Edit files in `lib/`
   - Follow PSR-2 coding style
   - Run `make phpcs` to check style
   - If adding dependencies: update `composer.json` then run `make composer`
   - Test with `make unit-test` (requires Nextcloud setup)

2. **For JavaScript/Vue changes**:
   - Edit files in `src/`
   - Run `npm run build` or `npm run dev` (development mode)
   - Run `npm run lint` and `npm run stylelint` early and often
   - Run `npm run test` before committing
   - Use `npm run watch` for continuous rebuild during development

3. **For documentation changes**:
   - Edit files in `docs/`
   - No build needed
   - Optionally run Vale linter if configured

### Before Creating a PR

**REQUIRED STEPS**:
1. Update `CHANGELOG.md` with your changes (or add `Skip-Changelog` label)
2. Sign off commits for DCO compliance: `git commit -s`
3. Run linting: `npm run lint && npm run stylelint`
4. Run tests: `npm run test`
5. Ensure build succeeds: `make build`
6. If PHP changes: run `make phpcs` (may need Nextcloud setup)

### Common Pitfalls

**Node Version Mismatch**: Package.json requires Node 24+ and npm 11.3+. If you see EBADENGINE warnings, the build will likely still work but consider upgrading.

**Missing Scoped Dependencies**: If `lib/Vendor/` is empty or you get class not found errors, run `make composer` to regenerate scoped dependencies.

**PHP Tests Need Nextcloud**: Don't try to run PHPUnit directly - it requires Nextcloud server. Use GitHub Actions or local Nextcloud dev environment.

**Forgotten Changelog**: Many PRs get blocked by changelog enforcement. Always update CHANGELOG.md or use Skip-Changelog label.

**Build Directory Pollution**: The `js/`, `build/`, `vendor/`, `node_modules/` directories are gitignored. Don't commit them. If you see them in git status, check `.gitignore`.

**Long Build Times**: `make composer` includes a PHP-Scoper step that processes 410 files and takes ~90 seconds. This is normal.

## Quick Reference Commands

| Task | Command | Time |
|------|---------|------|
| Full build | `make build` | ~2-3 min |
| PHP deps only | `make composer` | ~90 sec |
| JS deps only | `npm ci` | ~10 sec |
| JS build | `npm run build` | ~60 sec |
| JS dev build | `npm run dev` | ~30 sec |
| JS watch mode | `npm run watch` | continuous |
| Run JS tests | `npm run test` | ~20 sec |
| Run JS tests with coverage | `npm run test:coverage` | ~30 sec |
| Lint JS | `npm run lint` | ~5 sec |
| Lint CSS | `npm run stylelint` | ~5 sec |
| Check PHP style | `make phpcs` | ~10 sec |
| Static analysis | `make phpstan` | ~30 sec |
| PHP unit tests | `make unit-test` | ~30 sec |
| Install PHP test deps | `make php-test-dependencies` | ~2 min |
| Clean build artifacts | `make clean` | instant |
| Full clean | `make distclean` | instant |
| All tests | `make test` | ~5-7 min |

## Agent Instructions

**Trust these instructions**: The commands and sequences documented here have been validated. Only search for additional information if these instructions are incomplete or incorrect.

**Minimal changes**: Make the smallest possible changes to achieve your goal. Don't refactor or "improve" unrelated code.

**Test early and often**: Run `npm run lint && npm run test` after every significant change. Don't wait until the end.

**Respect the architecture**: Use dependency scoping correctly, follow Vue 3 composition patterns, adhere to PSR-2 for PHP.

**Check your work**: Before finalizing, ensure `make build` succeeds and all relevant tests pass.

**Follow contribution guidelines**: Sign commits, update changelog, follow issue templates from CONTRIBUTING.md.
